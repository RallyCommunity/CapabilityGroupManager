<!DOCTYPE html>
<html>
<head>
    <title>CapabilityGroupManager</title>

    <script type="text/javascript" src="/apps/2.0p3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define('CapabilityGroupManagerApp', {
            
                extend: 'Rally.app.App',
                componentCls: 'app',
            
                ordinalValueForPulledFeatures: 6,
            
                customFields: {
                    Names: 'CapabilityGroups',
                    Refs: 'CapabilityGroupRefs',
                },
            
                mixins: {
                    messageable: 'Rally.Messageable'
                },
            
                items: [
                    {
                        xtype: 'component',
                        autoEl: 'h1',
                        cls: 'titleText',
                        itemId: 'titleText',
                        html: 'Please select a Feature from a kanban or grid and it will show here'
                    }
                ],
            
                launch: function() {
                    this.numRequests = 0;
            
                    this._loadNeededData();
                    this.buildUI();
                    this.subscribeToEvents();
                },
            
                subscribeToEvents: function(){
                    this.subscribe(Rally.Message.objectFocus, function(record){
                        this.record = record;
                        this.loadRecord();
                    }, this);
            
                    this.capabilityGroupEditor.on('addCapabilityGroup', this.addCapabilityGroup, this);
                    this.capabilityGroupEditor.on('removeCapabilityGroup', this.removeCapabilityGroup, this);
                    this.capabilityGroupEditor.on('mvfOwnerChange', this._onMVFOwnerChange, this);
                    this.mvfTree.on('pullButtonClicked', this.pullFeature, this);
                },
            
                loadDummyRecordForTesting: function(){
                    // Temp - for testing:
                    Ext.create('Rally.data.WsapiDataStore', {
                        autoLoad: true,
                        model: 'TypeDefinition',
                        filters: [
                            {
                                property: 'Parent.Name',
                                value: 'Portfolio Item'
                            },
                            {
                                property: 'Ordinal',
                                value: 0
                            }
                        ],
                        listeners: {
                            load: function(store, records){
                                Rally.data.ModelFactory.getModel({
                                    type: records[0].get('TypePath'),
                                    success: function(model){
                                        model.load(5018681742, {
                                            callback: function(record) {
                                                this.publish(Rally.Message.objectFocus, record);
                                            },
                                            scope: this
                                        });
            
                                    },
                                    scope: this
                                });
                            },
                            scope: this
                        }
                    });
                    
                },
            
                _loadNeededData: function() {
            
                    // TODO - remove this:
                    // this.loadDummyRecordForTesting();
            
                    Ext.create('Rally.data.WsapiDataStore', {
                        autoLoad: true,
                        model: 'Project',
                        fetch: ['Name', '_ref', 'ObjectID'],
                        filters: [
                            {
                                property: 'Name',
                                operator: 'Contains',
                                value: 'MVF Backlog'
                            },
                            {
                                property: 'State',
                                operator: '=',
                                value: 'Open'
                            }
                        ],
                        listeners: {
                            load: function(store, records){
                                this.capabilityGroupStore = store;
                                this.loadRecord();
                            },
                            scope: this
                        }
                    });
            
            
                    Ext.create('Rally.data.WsapiDataStore', {
                        autoLoad: true,
                        model: 'TypeDefinition',
                        filters: [
                            {
                                property: 'Parent.Name',
                                value: 'Portfolio Item'
                            },
                            {
                                property: 'Ordinal',
                                value: 0
                            }
                        ],
                        listeners: {
                            load: function(store, records){
                                this.featureStateTypeDef = records[0].get('_ref');
                                
                                Rally.data.ModelFactory.getModel({
                                    type: records[0].get('TypePath'),
                                    success: function(model){
                                        this.lowestType = model;
                                        this.loadRecord();
                                    },
                                    scope: this
                                });
                            },
                            scope: this
                        }
                    });
                },
            
                loadRecord: function(){
                    this.setSaveMessage('');
                    
                    if(!this.capabilityGroupStore || !this.record || !this.lowestType || this.lowestType.typePath !== this.record.self.typePath) {
                        return;
                    }
            
                    //record not guaranteed to be fully hydrated, need to get the full object.
                    this.record.self.load(this.record.get('ObjectID'), {
                        success: this.onRecordLoaded,
                        fetch: ['Project', 'ObjectID', 'State', 'OrderIndex','TypeDef', 'Name', 'FormattedID', 'MVFOwner', 'MVFOwnerRef', 'CapabilityGroups', 'CapabilityGroupRefs'],
                        scope: this
                    });
            
                },
            
                onRecordLoaded: function(record){
                    this.record = record;
                    this.updateTitle();
                    this.drawCapabilityGroups();
            
                    this.mvfTree.redrawTree(this.record);
                    Ext.ComponentQuery.query('#addButton')[0].enable();
                    this._enableOrDisablePullStoriesButton();
                },
            
                buildUI: function() {
                    this.capabilityGroupEditor = this.add({
                        xtype: 'capabilitygroupeditor',
                        cls: 'leftSide'
                    });
            
                    this.mvfTree = this.add({
                        xtype: 'mvftree',
                        cls: 'rightSide'
                    });
                },
            
                parseCapabilityGroups: function(){
                    var capabilityGroups = this.record.get('CapabilityGroupRefs');
                    var refs = capabilityGroups && capabilityGroups.split(',') || [];
                    var newRefs = [];
            
                    Ext.Array.each(refs, function(ref){
                        var record = this.capabilityGroupStore.getById(Rally.util.Ref.getOidFromRef(ref));
                        if (record) {
                            newRefs.push({
                                ref: ref,
                                name: record.get('Name')
                            });
                        }
                    }, this);
            
                    return newRefs;
                },
            
                saveCapabilityGroups: function(refs, callback, scope){
                    this.setLoading(true);
                    this.record.set('CapabilityGroupRefs', Ext.Array.map(refs, function(ref){
                        return ref.ref;
                    }).join(','));
                    this.record.set('CapabilityGroups', Ext.Array.map(refs, function(ref){
                        return ref.name;
                    }).join(', '));
            
                    this.showSaveText();
                    this.record.save({
                        callback: function() {
                            this.hideSaveText();
                            callback.call(scope || this);
                        },
                        scope: this
                    });
                },
            
                showSaveText: function() {
                    this.numRequests++;
                    this.setSaveMessage('Saving...');
                },
            
                hideSaveText: function() {
                    this.numRequests--;
                    if(this.numRequests <= 0) {
                        this.setSaveMessage('Saved');
                    }
                },
            
                setSaveMessage: function(msg){
                    this.capabilityGroupEditor.setSaveMessage(msg);
                },
            
                _userStoryNameFor: function(capabilityGroup) {
                    if(capabilityGroup.get) {
                        return this.record.get('Name') + ' - ' + capabilityGroup.get('Name');
                    } else {
                        return this.record.get('Name') + ' - ' + capabilityGroup.name;
                    }
                },
            
                addCapabilityGroup: function(value){
                    var refs = this.parseCapabilityGroups();
            
                    var isDuplicate = Ext.Array.some(refs, function(ref){
                        return ref.ref == value;
                    });
                    if (isDuplicate) {
                        return;
                    }
            
                    var record = this.capabilityGroupStore.getById(Rally.util.Ref.getOidFromRef(value));
                    refs.push({
                        ref: value,
                        name: record.get('Name')
                    });
            
                    this.saveCapabilityGroups(refs, function(){
            
                        this._createUserStory({
                            Name: this._userStoryNameFor(record),
                            PortfolioItem: this.record.get('_ref'),
                            Project: this.record.get('Project')._ref,
                            ScheduleState: 'Defined'
                        }, function() {
                            this.mvfTree.redrawTree(this.record);
                            this._enableOrDisablePullStoriesButton();
                            this.setLoading(false);
                        }, this);
            
                    }, this);
                    this.drawCapabilityGroups();
                },
            
            
                removeCapabilityGroup: function(removeRef){
                    if(this.record && this.record.get('MVFOwnerRef') === removeRef) {
                        this.setOwner(null, true);
                    }
            
                    var capabilityGroupToRemove = this.capabilityGroupStore.getById(Rally.util.Ref.getOidFromRef(removeRef));
            
                    var refs = this.parseCapabilityGroups();
            
                    refs = Ext.Array.filter(refs, function(ref){
                        return ref.ref !== removeRef;
                    });
            
                    this.saveCapabilityGroups(refs, function(){
            
                        this._removeUserStory({
                            Name: this._userStoryNameFor(capabilityGroupToRemove),
                            PortfolioItem: this.record.get('_ref')
                        }, function() {
                            this.mvfTree.redrawTree(this.record);
                            this._enableOrDisablePullStoriesButton();
                            this.setLoading(false);
                        }, this);
            
                    }, this);
                    this.drawCapabilityGroups();
            
                },
            
                updateTitle: function() {
                    Ext.ComponentQuery.query('#titleText')[0].getEl().setHTML(this.record.get('FormattedID') + ' : ' + this.record.get('Name'));
                },
            
                setOwner: function(owner, dontSave) {
                    this.setLoading(true);
                    this.record.set('MVFOwner', owner && owner.name || '');
                    this.record.set('MVFOwnerRef', owner && owner.ref || '');
                    if(!dontSave) {
                        this.record.save({
                            callback: function(){
                                this.setLoading(false);
                                this._enableOrDisablePullStoriesButton();
                            },
                            scope: this
                        });
                    }
                },
            
                _onMVFOwnerChange: function(capabilityGroup) {
                    this.setOwner(capabilityGroup);
                },
            
                drawCapabilityGroups: function() {
            
                    var capabilityGroups = this.parseCapabilityGroups();
                    var mvfOwnerRef = this.record.get('MVFOwnerRef');
            
                    this.capabilityGroupEditor.drawCapabilityGroups(capabilityGroups, mvfOwnerRef);
                },
            
            
                pullFeature: function(){
                    this.mvfTree.showPulling(true);
            
                    this.pullChildStories(function(stories){
                        this.moveMVFToDev(function(){
                            this.saveAll(stories, function(){
                                this.mvfTree.redrawTree(this.record);
                                this._enableOrDisablePullStoriesButton();
                                this.mvfTree.showPulling(false);
                            }, this);
                        }, this);
                    }, this);
                },
            
                pullChildStories: function(callback, scope) {
                    Rally.data.ModelFactory.getModel({
                        type: 'Userstory',
                        success: function(UserStory) {
                            // Load child stories
                            var store = Ext.create('Rally.data.WsapiDataStore', {
                                autoLoad: true,
                                limit: Infinity,
                                model: 'User Story',
                                filters: [
                                    {
                                        property: 'PortfolioItem',
                                        value: this.record.get('_ref')
                                    }
                                ],
                                context: {
                                    project: this.record.get('Project')._ref,
                                    projectScopeDown: true
                                },
                                listeners: {
                                    load: function(store, records) {
                                        records = Ext.Array.clone(records);
                                        capabilityGroups = this.parseCapabilityGroups();
            
                                        var saveOne = function() {
                                            if(records.length > 0) {
                                                record = records.shift();
            
                                                Ext.Array.each(capabilityGroups, function(group){
                                                    if(record.get('Name') === this._userStoryNameFor(group)) {
                                                        record.set('Project', group.ref);
                                                    }
                                                }, this);
                                                record.save({
                                                    success: saveOne,
                                                    scope: this
                                                });
                                            } else {
                                                if (callback) {
                                                    callback.call(scope || this, records);
                                                }
                                            }
                                        };
                                        saveOne.call(this);
                                    },
                                    scope: this
                                }
                            });
                        },
                        scope: this
                    });
                },
            
                /**
                * Given an array of model objects, saves them sequentially, one at a time.
                */
                saveAll: function(items, callback, scope) {
                    items = Ext.Array.clone(items);
                    var saveOne = function(){
                        if (items.length > 0) {
                            item = items.shift();
                            item.save({
                                success: saveOne
                            });
                        } else {
                            callback.call(scope || this);
                        }
                    }
                    saveOne();
                },
            
                moveMVFToDev: function(callback, scope) {
                    var ownerRef = this.record.get('MVFOwnerRef');
                    if (ownerRef) {
                        this.record.set({
                            Project: ownerRef
                        });
                    }
                    if(this.featureStateTypeDef) {
                        Ext.create('Rally.data.WsapiDataStore', {
                            autoLoad: true,
                            model: 'State',
                            filters: [
                                {
                                    property: 'TypeDef',
                                    value: this.featureStateTypeDef
                                },
                                {
                                    property: 'OrderIndex',
                                    value: this.ordinalValueForPulledFeatures
                                }
                            ],
                            listeners: {
                                load: function(store, records){
                                    if(records.length > 0) {
                                        this.record.set('State', records[0].get('_ref'));
                                        this.record.save({
                                            callback: function(){
                                                if(callback){
                                                    callback.call(scope || this);
                                                }
                                            },
                                            scope: scope
                                        });
                                    }
                                },
                                scope: this
                            }
                        });
                    }
                },
            
                _createUserStory: function(data, callback, scope) {
            
                    Rally.data.ModelFactory.getModel({
                        type: 'Userstory',
                        success: function(UserStory) {
            
                            var story = new UserStory(data);
            
                            story.save({
                                callback: function() {
                                    if (callback) {
                                        callback.call(scope || this, story);
                                    }
                                },
                                scope: scope || this
                            });
                        },
                        scope: this
                    });
                },
            
                _removeUserStory: function(data, callback, scope) {
            
                    var filters = [];
                    Ext.Object.each(data, function(key, value) {
                        filters.push({
                            property: key,
                            value: value
                        });
                    });
            
                    Ext.create('Rally.data.WsapiDataStore', {
                        autoLoad: true,
                        model: 'UserStory',
                        filters: filters,
                        context: {
                            project: null
                        },
                        listeners: {
                            load: function(store, records){
                                if (records && records.length > 0){
                                    records[0].destroy({
                                        success: callback,
                                        scope: scope || this
                                    });
                                } else {
                                    callback.call(scope || this);
                                }
                            },
                            scope: this
                        }
                    });
                },
            
                _enableOrDisablePullStoriesButton: function() {
            
                    var mvfOwnerRef = this.record.get('MVFOwnerRef');
            
                    if(!mvfOwnerRef || (mvfOwnerRef && this.record.get('Project')._ref === mvfOwnerRef)) {
                        Rally.data.ModelFactory.getModel({
                            type: 'Userstory',
                            success: function(UserStory) {
                                // Load child stories
                                var store = Ext.create('Rally.data.WsapiDataStore', {
                                    autoLoad: true,
                                    limit: Infinity,
                                    model: 'User Story',
                                    filters: [
                                        {
                                            property: 'PortfolioItem',
                                            value: this.record.get('_ref')
                                        }
                                    ],
                                    context: {
                                        project: null
                                    },
                                    listeners: {
                                        load: function(store, records) {
                                            capabilityGroups = this.parseCapabilityGroups();
            
                                            var allChildrenInCapabilityGroupProject = true;
                                            Ext.Array.each(records, function(record){
                                                var projectRef = record.get('Project')._ref;
                                                var name = record.get('Name');
            
                                                Ext.Array.each(capabilityGroups, function(capabilityGroup){
                                                    if(name === this._userStoryNameFor(capabilityGroup) && projectRef !== capabilityGroup.ref) {
                                                        allChildrenInCapabilityGroupProject = false;
                                                    }
                                                }, this);
                                            },this);
            
                                            if(allChildrenInCapabilityGroupProject) {
                                                this.mvfTree.disablePull();
                                            } else {
                                                this.mvfTree.enablePull();
                                            }
            
                                        },
                                        scope: this
                                    }
                                });
                            },
                            scope: this
                        });
                    } else {
                        this.mvfTree.enablePull();
                    }
            
                    if(!mvfOwnerRef) {
                        if(this.parseCapabilityGroups().length > 0) {
                            this.mvfTree.setOwnerText('Please select an owner');    
                        } else {
                            this.mvfTree.hideOwnerText();
                        }
                    } else if (mvfOwnerRef !== this.record.get('Project')._ref) {
                        this.mvfTree.setOwnerText("Click 'Pull' to move the Feature into the new owner's project");
                    } else {
                        this.mvfTree.hideOwnerText();
                    }
                    
                }
            
            
            
            }, function(){
                if (!Rally.Message.objectFocus){
                    Rally.Message.objectFocus = "objectfocus"; // hack to get it to run externally
                }
            }); 
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            Ext.define('CapabilityGroupCombobox', {
            	extend: 'Rally.ui.combobox.ComboBox',
                alias: 'widget.capabilitygroupcombobox',
            
                constructor: function(config) {
                    var defaultConfig = {
                        stateful: false,
                        fieldLabel: 'Capability Group',
                        labelWidth: 95,
                        labelClsExtra: 'rui-label',
                        storeConfig: {
                            autoLoad: true,
                            model: 'Project',
                            fetch: ['Name', '_ref', 'ObjectID'],
                            sorters: {
                                property: 'Name',
                                direction: 'ASC'
                            },
                            filters: [
                                {
                                    property: 'Name',
                                    operator: 'Contains',
                                    value: 'MVF Backlog'
                                },
                                {
                                    property: 'State',
                                    operator: '=',
                                    value: 'Open'
                                }
                            ]
                        }
                    };
            
                    this.callParent([Ext.Object.merge(defaultConfig, config)]);
                }
            
            });            Ext.define('GettyTreeItem', {
            	extend: 'Rally.ui.tree.TreeItem',
            	requires: ['Rally.ui.tree.TreeItem'],
            	alias: 'widget.gettytreeitem',
            
                getPillTpl: function(){
            	    var me = this;
            
            	    return Ext.create('Ext.XTemplate',
            	            '<div class="pill {[this.getSelectableCls()]}">',
            	            '<tpl if="this.canDrag()"><div class="icon drag"></div></tpl>',
            	            '<div class="textContent ellipses">{[this.getFormattedId()]} {[this.getType(values)]}{[this.getSeparator()]}{Name}</div>',
            	            '<div class="rightSide">',
            	            '{[this.getProject(values)]}',
            	            '{[this.getPercentDone(values)]}',
            	            '</div>',
            	            '</div>',
            	            {
            	                getSelectableCls: function(){
            	                    return me.getSelectable()? 'selectable': '';
            	                },
            	                canDrag: function(){
            	                    return me.getCanDrag();
            	                },
            	                getFormattedId: function(){
            	                    return me.getRecord().getField('FormattedID')? me.getRecord().render('FormattedID'): '';
            	                },
            	                getType: function(values){
            	                    return values.PortfolioItemType? '(' + values.PortfolioItemType._refObjectName + ')': '';
            	                },
            	                getProject: function() {
            	                	return '<div class="row-project">' + me.getRecord().render('Project') + '</div>';
            	                },
            	                getPercentDone: function(){
            	                    return Ext.isDefined(me.getRecord().get('PercentDoneByStoryCount'))? me.getRecord().render('PercentDoneByStoryCount'): '';
            	                },
            	                getSeparator: function(){
            	                    return this.getFormattedId()? ' - ': '';
            	                }
            	            }
            	    );
            	}
            });            Ext.define('CapabilityGroupEditor', {
            	extend: 'Ext.Container',
            	alias: 'widget.capabilitygroupeditor',
            
            	items: [
                    {
            	        xtype: 'component',
            	        autoEl: 'h2',
            	        cls: 'subTitleText',
            	        itemId: 'subTitleText',
            	        html: 'Capability Groups:'
            	    },
            	    {
            	        xtype: 'container',
            	        cls: 'capabilityGroups',
            	        itemId: 'capabilityGroups',
            	        html: ''
            	    },
            	    {
            	        xtype: 'container',
            	        items: [
            	            {
            	                xtype: 'capabilitygroupcombobox',
            	                fieldLabel: '',
            	                itemId: 'capabilityGroupCombobox',
            	                cls: 'capabilityGroupCombobox',
            	                labelWidth: 0
            	            },
            	            {
            	                xtype: 'button',
            	                itemId: 'addButton',
            	                cls: 'addButton',
            	                disabled: true,
            	                text: 'Add'
            	            },
            	            {
            	                xtype: 'component',
            	                cls: 'saveText',
            	                itemId: 'saveText'
            	            }
            	        ]
            	    }
                ],
            
                initComponent: function(){
                	this.callParent(arguments);
                	this.dropdown = Ext.ComponentQuery.query('#capabilityGroupCombobox')[0];
                	Ext.ComponentQuery.query('#addButton')[0].on('click', this._onClickAddButton, this);
                },
            
                _onClickAddButton: function(){
                	var value = this.dropdown.getValue();
                	this.addCapabilityGroup(value);
                },
            
                addCapabilityGroup: function(value){
                	this.fireEvent('addCapabilityGroup', value);
                },
            
                removeCapabilityGroup: function(value) {
                	this.fireEvent('removeCapabilityGroup', value);
                },
            
                drawCapabilityGroups: function(capabilityGroups, mvfOwnerRef) {
            
                    var capabilityGroupsComponent = Ext.ComponentQuery.query('#capabilityGroups')[0];
                    capabilityGroupsComponent.removeAll();
            
                    if(capabilityGroups.length <= 0) {
                        return;
                    }
            
                    Ext.Array.each(capabilityGroups, function(capabilityGroup){
                        var container = capabilityGroupsComponent.add({
                            xtype: 'container',
                            cls: 'capabilityGroup',
                            items: [
                                {
                                    xtype: 'checkbox',
                                    cls: 'ownerCheckbox',
                                    boxLabel: capabilityGroup.name,
                                    boxLabelAttrTpl: 'style="position: relative; top: 2px;"',
                                    checked: mvfOwnerRef === capabilityGroup.ref,
                                    value: mvfOwnerRef === capabilityGroup.ref,
                                    data: capabilityGroup.ref,
                                    listeners: {
                                        change: function(checkbox, isChecked) {
                                        	this._onCheckboxChange(checkbox, isChecked, capabilityGroup);
                                        },
                                        scope: this
                                    }
                                },
                                {
                                    xtype: 'rallybutton',
                                    ui: 'link',
                                    cls: 'deleteCapabilityGroup',
                                    html: 'X',
                                    tooltip: 'Remove',
                                    tooltipType: 'title',
                                    listeners: {
                                        click: function() {
                                            this.removeCapabilityGroup(capabilityGroup.ref);
                                        },
                                        scope: this
                                    }
                                },
                                {
                                    xtype: 'component',
                                    itemId: 'ownerText',
                                    cls: 'ownerText',
                                    html: 'Owner'
                                }
                            ]
                        });
                    }, this);
                },
            
                _onCheckboxChange: function(checkbox, isChecked, capabilityGroup) {
                    
                    var currentCheckedCheckbox;
                    Ext.Array.each(Ext.ComponentQuery.query('checkbox'), function(loopCheckbox){
                    	if(loopCheckbox.getValue() === true && loopCheckbox != checkbox) {
                    		currentCheckedCheckbox = loopCheckbox;
                    	}
                    }, this);
            
                    if(!this.uncheckingPreviousCheckbox) {
                    	this.fireEvent('mvfOwnerChange', isChecked ? capabilityGroup : null);
                    }
                    
                	if(currentCheckedCheckbox && !this.uncheckingPreviousCheckbox && currentCheckedCheckbox !== checkbox) {
                		this.uncheckingPreviousCheckbox = true;
                		currentCheckedCheckbox.setValue(false);
                	}
            
                	this.uncheckingPreviousCheckbox = false;
                },
            
                setSaveMessage: function(msg) {
                	Ext.ComponentQuery.query('#saveText')[0].getEl().setHTML(msg);
                }
            });            Ext.define('MVFTree', {
            	extend: 'Ext.Container',
            	alias: 'widget.mvftree',
            
            	items: [
                    {
                        xtype: 'rallybutton',
                        itemId: 'pullButton',
                        cls: 'pullButton',
                        disabled: true,
                        width: 140,
                        text: 'Pull stories from Feature'
                    },
                    {
                        xtype: 'component',
                        itemId: 'pullText',
                        cls: 'pullText',
                        html: 'Moving stories to the right project...'
                    },
                    {
                    	xtype: 'component',
                    	itemId: 'changeOwnerText',
                    	cls: 'changeOwnerText',
                    	html: ''
                    }
            	],
            
            	initComponent: function() {
            		this.callParent(arguments);
            		this.pullButton = Ext.ComponentQuery.query('#pullButton')[0];
            		this.pullButton.on('click', this._onPullButtonClicked, this);
            	},
            
            	_onPullButtonClicked: function() {
            		this.fireEvent('pullButtonClicked');
            	},
            
            	setOwnerText: function(msg) {
            		Ext.ComponentQuery.query('#changeOwnerText')[0].addCls('changeOwnerTextVisible');
            		Ext.ComponentQuery.query('#changeOwnerText')[0].getEl().setHTML(msg);
            	},
            
            	hideOwnerText: function() {
            		Ext.ComponentQuery.query('#changeOwnerText')[0].removeCls('changeOwnerTextVisible');
            	},
            
            	enablePull: function(){
                    this.pullButton.setText('Pull stories from Feature');
                    this.pullButton.enable();
            	},
            
            	disablePull: function(){
                    this.pullButton.setText('No changes');
                    this.pullButton.disable();
            	},
            
            	showPulling: function(pulling){
            		if (pulling) {
            	        this.pullButton.disable();
            	        Ext.ComponentQuery.query('#pullText')[0].addCls('pullTextVisible');
            	    } else {
            	        this.pullButton.enable();
            	        Ext.ComponentQuery.query('#pullText')[0].removeCls('pullTextVisible');
            	    }
            	},
            
                redrawTree: function(record) {
            
                    var tree = Ext.ComponentQuery.query('#capabilityGroupTree');
                    if(tree && tree.length > 0) {
                        tree[0].destroy();
                    }
            
                    this.drawTree(record);
                },
            
                drawTree: function(record) {
                    this.add({
                        xtype: 'rallytree',
                        cls: 'capabilityGroupTree',
                        itemId: 'capabilityGroupTree',
                        topLevelModel: record.self.typePath,
                        parentAttributeForChildRecordFn: function() {
                            return 'PortfolioItem';
                        },
                        topLevelStoreConfig: {
                            filters: [
                                {
                                    property: 'ObjectID',
                                    value: record.get('ObjectID')
                                }
                            ],
                            context: {
                                project: record.get('Project')._ref
                            },
                            fetch: ['Name', 'DirectChildrenCount', 'FormattedID', 'ObjectID', 'Project']
                        },
                        childItemsStoreConfigForParentRecordFn: function(){
                            return {
                                sorters: []
                            };
                        },
                        canExpandFn: function(record){
                            return record.get('DirectChildrenCount') > 0;
                        },
                        treeItemConfigForRecordFn: function(){
                            return {
                                xtype: 'gettytreeitem'
                            };
                        },
                        listeners: {
                            toplevelload: function() {
                                var treeItem = Ext.ComponentQuery.query('#capabilityGroupTree rallytreeitem')[0];
                                Ext.ComponentQuery.query('#capabilityGroupTree')[0].expandItem(treeItem);
                                treeItem.setExpanded(true);
                                treeItem.draw();
                            },
                            scope: this
                        },
                        scope: this
                    });
                },
            });
            Rally.launchApp('CapabilityGroupManagerApp', {
                name: 'CapabilityGroupManager'
            });
        });
    </script>

    <style type="text/css">
        .app {
             padding: 10px;
        }
        
        .app .titleText {
        	font-size: 20px;
        	border-bottom: 1px solid #AAA;
        	margin-bottom: 10px;
        }
        
        .app .leftSide {
        	float: left;
        	width: 50%;
        }
        
        .app .leftSide .subTitleText {
        	font-size: 14px;
        	margin: 4px 0;
        }
        
        .app .leftSide .capabilityGroups {
        	margin: 8px 0;
        	padding: 5px;
        	height: 150px;
        	border: 2px inset #AAA;
        	overflow: auto;
        }
        
        .app .leftSide .capabilityGroup {
        }
        
        .app .leftSide .capabilityGroupOwner {
        	float: left;
        	margin-top: 5px;
        	margin-right: 10px;
        }
        
        .app .leftSide .ownerCheckbox {
        	float: left;
        	margin-right: 5px;
        }
        
        .app .leftSide .capabilityGroupName {
        	float: left;
        	margin-top: 5px;
        }
        
        .app .leftSide .ownerText {
        	float: left;
        	color: #777;
        	margin-top: 5px;
        	visibility: hidden;
        }
        
        .app .leftSide .x-form-cb-checked ~ .ownerText {
        	visibility: visible !important;
        }
        
        .app .leftSide .deleteCapabilityGroup {
        	float: left;
        	color: #888;
        	font-weight: bold;
        	padding: 2px 0 0 0;
        }
        
        .app .leftSide .capabilityGroupCombobox {
        	float: left;
        	margin-right: 10px;
        	margin-top: 2px;
        }
        
        .app .leftSide .addButton {
        	float: left;
        }
        
        .app .leftSide .saveText {
        	float: left;
        	color: #777;
        	font-size: 14px;
        	margin: 4px 5px;
        }
        
        .app>.rightSide {
        	float: left;
        	width: 50%;
        	padding-left: 20px;
        }
        
        .app .rightSide .pullButton{
        	float: left;
        }
        
        .app .rightSide .pullText {
        	font-size: 14px;
        	padding: 3px 5px;
        	float: left;
        	color: #444;
        	display: none;
        }
        
        .app .rightSide .changeOwnerText {
        	float: left;
        	padding: 5px;
        	color: red;
        	display: none;
        }
        
        .app .rightSide .changeOwnerTextVisible {
        	display: block;
        }
        
        .app .rightSide .pullTextVisible {
        	display: block;
        }
        
        .app .rightSide .capabilityGroupTree {
        	padding: 10px;
        	clear: both;
        }
        
        .app .rightSide .pill {
        	overflow: auto;
        }
        
        .app .rightSide .textContent {
        	float: left;
        	margin-right: 0;
        }
        
        .app .rightSide .pill .rightSide {
        	float: right;
        }
        
        .app .rightSide .pill .rightSide .row-project {
        	float: right;
        }
        
        .app .rightSide .pill .percentDoneContainer {
        	float: right;
        	position: relative;
        	margin-right: 10px;
        	right: 0;
        	top: 0;
        }
        
    </style>
</head>
<body></body>
</html>
